<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dieta Personalizzata</title>
  <meta name="description" content="Web app per generare la pagina centrale di un piano dieta giornaliero e combinarla con pagine fisse." />
  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    /*
     * Colori e tipografia
     * Le variabili CSS permettono di modificare facilmente la palette.
     */
    :root {
      --bg: #f9fafb;
      --panel: #ffffff;
      --border: #e2e8f0;
      --primary: #0ea5e9;
      --primary-dark: #0369a1;
      --success: #10b981;
      --warning: #f97316;
      --danger: #ef4444;
      --text: #1e293b;
      --muted: #64748b;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 2px 6px rgba(0,0,0,0.1);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.5;
    }
    header {
      text-align: center;
      padding: 32px 16px 20px;
    }
    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 4vw, 2.4rem);
      color: var(--primary-dark);
      font-weight: 700;
    }
    header p {
      margin: 6px 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    main {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: center;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 16px 48px;
    }
    /*
     * Sezione controlli
     */
    .controls {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      flex: 1 1 320px;
      max-width: 420px;
    }
    .controls h2 {
      margin-top: 0;
      font-size: 1.25rem;
      color: var(--primary-dark);
    }
    .controls label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .controls input[type="text"], .controls textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      margin-bottom: 16px;
      background: #fff;
      resize: vertical;
    }
    .controls textarea {
      min-height: 80px;
    }
    .controls .slider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .controls input[type="range"] {
      flex: 1;
    }
    .controls output {
      min-width: 70px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: monospace;
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    button {
      appearance: none;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button.primary {
      background: var(--primary);
      color: #fff;
    }
    button.primary:hover:not([disabled]) {
      background: var(--primary-dark);
    }
    button.success {
      background: var(--success);
      color: #fff;
    }
    button.success:hover:not([disabled]) {
      background: #047857;
    }
    button.warn {
      background: var(--warning);
      color: #fff;
    }
    button.warn:hover:not([disabled]) {
      background: #c2410c;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 8px;
    }
    /*
     * Sezione anteprima
     */
    .preview {
      flex: 2 1 500px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }
    .page {
      position: relative;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      width: 200px;
      aspect-ratio: 210 / 297;
      display: flex;
      flex-direction: column;
    }
    /* Central page is slightly wider to highlight content */
    .page.central {
      width: 240px;
    }
    .page img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #fff;
    }
    .page.locked::after {
      content: "Pagina bloccata";
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 4px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.7rem;
    }
    .inner {
      padding: 16px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    th, td {
      padding: 4px 2px;
      border-bottom: 1px dashed var(--border);
      vertical-align: top;
    }
    th { text-align: left; color: var(--primary-dark); font-weight: 600; }
    .meal-row { background: #f1f5f9; font-weight: 600; }
    .kcal { text-align: right; font-variant-numeric: tabular-nums; font-family: monospace; }
    .tag {
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.6rem;
      margin-left: 4px;
    }
    .subtotal { color: var(--muted); font-size: 0.65rem; }
    .history {
      margin-top: 24px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
      font-size: 0.8rem;
    }
    .history-item .meta { color: var(--muted); font-size: 0.75rem; }
    .history-item button {
      font-size: 0.75rem;
      padding: 6px 10px;
    }
    footer {
      text-align: center;
      padding: 24px;
      font-size: 0.75rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>Dieta Personalizzata</h1>
    <p>Genera la pagina centrale della dieta e combinala con il frontespizio e i consigli fissi.</p>
  </header>
  <main>
    <!-- Controlli -->
    <section class="controls">
      <h2>Impostazioni</h2>
      <div class="slider">
        <label for="calories">Calorie</label>
        <input id="calories" type="range" min="500" max="4000" step="50" value="2000" />
        <output id="caloriesOut">2000 kcal</output>
      </div>
      <label for="patientName">Nome paziente</label>
      <input id="patientName" type="text" placeholder="Es. Mario Rossi" />
      <label for="includeFoods">Alimenti da includere (separati da virgola)</label>
      <textarea id="includeFoods" placeholder="es. tonno, avocado, yogurt greco"></textarea>
      <label for="excludeFoods">Alimenti da escludere (separati da virgola)</label>
      <textarea id="excludeFoods" placeholder="es. lattosio, glutine, arachidi"></textarea>
      <div class="slider">
        <label for="tolerance">Tolleranza</label>
        <input id="tolerance" type="range" min="5" max="8" step="1" value="8" />
        <output id="toleranceOut">±8%</output>
      </div>
      <div class="btn-group">
        <button id="genBtn" class="primary">Genera Dieta</button>
        <button id="saveBtn" class="success" disabled>Salva in Storico</button>
        <button id="pdfBtn" class="warn" disabled>Esporta PDF</button>
      </div>
      <p class="note">I valori inseriti vengono salvati automaticamente e ripristinati al caricamento.</p>
      <div class="history" id="historyList"></div>
    </section>
    <!-- Anteprima -->
    <section class="preview">
      <div class="page locked">
        <img id="firstImg" alt="Frontespizio" />
      </div>
      <div class="page central">
        <div class="inner">
          <div id="dietHead" style="margin-bottom:10px;">
            <strong style="color: var(--primary-dark);">DIETA PERSONALIZZATA – GIORNALIERA</strong>
            <div style="font-size:0.7rem; color: var(--muted);">
              <span id="labelPatient">Paziente: —</span> · <span id="labelKcal">Fabbisogno: — kcal</span>
            </div>
            <div style="font-size:0.65rem; color: var(--muted);">Ripartizione: 20% · 10% · 40% · 10% · 20%</div>
          </div>
          <table id="dietTable">
            <thead>
              <tr><th>Sezione / Alimento</th><th>Quantità</th><th class="kcal">kcal</th></tr>
            </thead>
            <tbody id="dietBody">
              <tr><td colspan="3" style="color: var(--muted);">Premi <strong>Genera Dieta</strong> per compilare questa pagina.</td></tr>
            </tbody>
            <tfoot>
              <tr class="meal-row"><td>Totale giornata</td><td></td><td class="kcal" id="totalKcal">—</td></tr>
            </tfoot>
          </table>
          <p style="font-size:0.6rem; color: var(--muted); margin-top:6px;">* Le calorie sono stime approssimate in base alle porzioni e alla tolleranza. Gli alimenti esclusi non vengono utilizzati; quelli inclusi sono integrati quando compatibili.</p>
        </div>
      </div>
      <div class="page locked">
        <img id="lastImg" alt="Consigli" />
      </div>
    </section>
  </main>
  <footer>
    L'esportazione PDF inserisce il frontespizio, la pagina dieta generata e la pagina dei consigli come asset fissi, senza modificarli.
  </footer>
  <script>
  /*
   * Imposta i percorsi degli asset fissi. Nella cartella "assets" sono presenti:
   * - pagine_fisse.pdf (prima + ultima pagina)
   * - pagina1.pdf / paginaUltima.pdf (separate)
   * - pagina1.png / paginaUltima.png (anteprima)
   */
  const USE_SINGLE_FIXED_PDF = true;
  const FIXED_PDF_URL = "./assets/pagine_fisse.pdf";
  const FIRST_PDF = "./assets/pagina1.pdf";
  const LAST_PDF  = "./assets/paginaUltima.pdf";
  const FIRST_IMG = "./assets/pagina1.png";
  const LAST_IMG  = "./assets/paginaUltima.png";
  // Carica immagini anteprima
  document.getElementById('firstImg').src = FIRST_IMG;
  document.getElementById('lastImg').src = LAST_IMG;

  /* Stato e localStorage */
  const lsLast = 'dp2_last';
  const lsHist = 'dp2_history';
  const els = {
    cal: document.getElementById('calories'),
    calOut: document.getElementById('caloriesOut'),
    name: document.getElementById('patientName'),
    inc: document.getElementById('includeFoods'),
    exc: document.getElementById('excludeFoods'),
    tol: document.getElementById('tolerance'),
    tolOut: document.getElementById('toleranceOut'),
    gen: document.getElementById('genBtn'),
    save: document.getElementById('saveBtn'),
    pdf: document.getElementById('pdfBtn'),
    patientLabel: document.getElementById('labelPatient'),
    kcalLabel: document.getElementById('labelKcal'),
    tbody: document.getElementById('dietBody'),
    total: document.getElementById('totalKcal'),
    history: document.getElementById('historyList')
  };
  let currentPlanData = null;

  function normalize(str) {
    return (str || '')
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9\s]/g, '')
      .trim();
  }
  function splitList(val) {
    return (val || '').split(',').map(s => normalize(s)).filter(Boolean);
  }
  function saveLast() {
    const obj = { cal: +els.cal.value, name: els.name.value, inc: els.inc.value, exc: els.exc.value, tol: +els.tol.value };
    localStorage.setItem(lsLast, JSON.stringify(obj));
  }
  function loadLast() {
    const raw = localStorage.getItem(lsLast);
    if (!raw) return;
    try {
      const o = JSON.parse(raw);
      if (o.cal) { els.cal.value = o.cal; els.calOut.textContent = `${o.cal} kcal`; }
      if (o.name) els.name.value = o.name;
      if (o.inc != null) els.inc.value = o.inc;
      if (o.exc != null) els.exc.value = o.exc;
      if (o.tol) { els.tol.value = o.tol; els.tolOut.textContent = `±${o.tol}%`; }
    } catch {}
  }
  function getHistory() {
    try { return JSON.parse(localStorage.getItem(lsHist) || '[]'); } catch { return []; }
  }
  function setHistory(arr) { localStorage.setItem(lsHist, JSON.stringify(arr || [])); }
  function generateId() {
    // Simple UUID v4 generator fallback
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function renderHistory() {
    const arr = getHistory();
    els.history.innerHTML = '';
    if (!arr.length) {
      els.history.innerHTML = '<p style="font-size:0.8rem; color: var(--muted);">Storico vuoto</p>';
      return;
    }
    for (const item of arr) {
      const div = document.createElement('div');
      div.className = 'history-item';
      const left = document.createElement('div');
      left.innerHTML = `<div><strong>${item.name || '—'}</strong> · ${item.cal} kcal</div><div class="meta">${new Date(item.ts).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const loadBtn = document.createElement('button'); loadBtn.textContent = 'Ricarica'; loadBtn.className = 'primary';
      const delBtn = document.createElement('button'); delBtn.textContent = 'Elimina'; delBtn.className = 'warn';
      loadBtn.onclick = () => { loadPlan(item); };
      delBtn.onclick = () => {
        const newArr = getHistory().filter(x => x.id !== item.id);
        setHistory(newArr);
        renderHistory();
      };
      right.append(loadBtn, delBtn);
      div.append(left, right);
      els.history.append(div);
    }
  }
  /*
   * Database alimenti: kcal per 100g o per pezzo
   */
  const FOODS = {
    fats: [
      { key:'olio evo', name:'Olio EVO', kcal100: 900, unit:'g' },
      { key:'avocado', name:'Avocado', kcal100: 160, unit:'g' },
      { key:'mandorle', name:'Mandorle', kcal100: 579, unit:'g' },
      { key:'noci', name:'Noci', kcal100: 654, unit:'g' }
    ],
    carbs: [
      { key:'fiocchi avena', name:"Fiocchi d'avena", kcal100: 389, unit:'g' },
      { key:'pane integrale', name:'Pane integrale', kcal100: 250, unit:'g' },
      { key:'riso basmati', name:'Riso basmati (crudo)', kcal100: 360, unit:'g' },
      { key:'pasta integrale', name:'Pasta integrale (cruda)', kcal100: 350, unit:'g' },
      { key:'quinoa', name:'Quinoa (cruda)', kcal100: 368, unit:'g' },
      { key:'farro', name:'Farro (crudo)', kcal100: 335, unit:'g' },
      { key:'patate dolci', name:'Patate dolci', kcal100: 86, unit:'g' }
    ],
    proteins: [
      { key:'pollo', name:'Petto di pollo (cotto)', kcal100: 165, unit:'g' },
      { key:'tacchino', name:'Tacchino (cotto)', kcal100: 135, unit:'g' },
      { key:'tonno', name:'Tonno al naturale', kcal100: 116, unit:'g' },
      { key:'salmone', name:'Salmone (cotto)', kcal100: 208, unit:'g' },
      { key:'tofu', name:'Tofu', kcal100: 76, unit:'g' },
      { key:'ceci', name:'Ceci (cotti)', kcal100: 164, unit:'g' },
      { key:'lenticchie', name:'Lenticchie (cotte)', kcal100: 116, unit:'g' },
      { key:'uova', name:'Uova intere', unit:'pz', kcalPerUnit:78, gramsPerUnit:50 }
    ],
    dairy: [
      { key:'yogurt greco', name:'Yogurt greco 0%', kcal100: 59, unit:'g' },
      { key:'latte avena', name:"Latte d'avena", kcal100: 47, unit:'ml' },
      { key:'proteine', name:'Proteine in polvere', kcal100: 390, unit:'g' }
    ],
    fruits: [
      { key:'mela', name:'Mela', kcal100: 52, unit:'g' },
      { key:'pera', name:'Pera', kcal100: 57, unit:'g' },
      { key:'banana', name:'Banana', kcal100: 89, unit:'g' },
      { key:'frutti bosco', name:'Frutti di bosco', kcal100: 50, unit:'g' }
    ],
    veggies: [
      { key:'spinaci', name:'Spinaci', kcal100: 23, unit:'g' },
      { key:'zucchine', name:'Zucchine', kcal100: 17, unit:'g' },
      { key:'carote', name:'Carote', kcal100: 41, unit:'g' },
      { key:'pomodorini', name:'Pomodorini', kcal100: 18, unit:'g' },
      { key:'insalata', name:'Insalata', kcal100: 15, unit:'g' },
      { key:'broccoli', name:'Broccoli', kcal100: 34, unit:'g' },
      { key:'cavolo cappuccio', name:'Cavolo cappuccio', kcal100: 25, unit:'g' }
    ],
    sweeteners: [
      { key:'miele', name:'Miele', kcal100: 304, unit:'g' },
      { key:'cacao', name:'Cacao amaro', kcal100: 228, unit:'g' }
    ]
  };
  function chooseFood(list, includes, excludes) {
    for (const inc of includes) {
      const f = list.find(item => normalize(item.key).includes(inc) || normalize(item.name).includes(inc));
      if (f && !isExcluded(f, excludes)) return f;
    }
    return list.find(item => !isExcluded(item, excludes)) || null;
  }
  function isExcluded(food, excludes) {
    const key = normalize(food.key || food.name);
    return excludes.some(ex => key.includes(ex));
  }
  function kcalOf(food, qty) {
    if (food.unit === 'pz') return (food.kcalPerUnit || 0) * qty;
    return (food.kcal100 || 0) * (qty / 100);
  }
  function fmtQty(food, qty) {
    if (food.unit === 'pz') return `${qty} pz`;
    return `${Math.round(qty)} ${food.unit}`;
  }
  function fmtKcal(k) { return Math.round(k); }
  function tunePortions(items, target) {
    const total = items.reduce((s, it) => s + kcalOf(it.food, it.qty), 0);
    if (!total) return items;
    const ratio = target / total;
    const minF = 0.6, maxF = 1.6;
    for (const it of items) {
      const f = Math.max(minF, Math.min(maxF, ratio));
      it.qty = it.qty * f;
    }
    return items;
  }
  function buildBreakfast(target, inc, exc) {
    const yogurt = FOODS.dairy.find(f => f.key === 'yogurt greco');
    const oats   = FOODS.carbs.find(f => f.key === 'fiocchi avena');
    const fruit  = chooseFood(FOODS.fruits, inc, exc);
    const nuts   = chooseFood([FOODS.fats.find(f => f.key === 'mandorle'), FOODS.fats.find(f => f.key === 'noci'), FOODS.fats.find(f => f.key === 'avocado')].filter(Boolean), inc, exc);
    const honey  = FOODS.sweeteners.find(f => f.key === 'miele');
    let items = [
      { food: yogurt, qty: 180 },
      { food: oats, qty: 40 },
      { food: fruit, qty: 120 },
      { food: nuts, qty: 15 }
    ];
    if (honey && !isExcluded(honey, exc)) items.push({ food: honey, qty: 10 });
    items = items.filter(x => x.food && !isExcluded(x.food, exc));
    return tunePortions(items, target);
  }
  function buildSnack(target, inc, exc) {
    const fruit = chooseFood(FOODS.fruits, inc, exc);
    const nuts  = chooseFood([FOODS.fats.find(f => f.key === 'mandorle'), FOODS.fats.find(f => f.key === 'noci')].filter(Boolean), inc, exc);
    let items = [ { food: fruit, qty: 140 }, { food: nuts, qty: 15 } ];
    items = items.filter(x => x.food && !isExcluded(x.food, exc));
    return tunePortions(items, target);
  }
  function buildMainMeal(target, inc, exc) {
    const carb = chooseFood([
      FOODS.carbs.find(f => f.key === 'riso basmati'),
      FOODS.carbs.find(f => f.key === 'quinoa'),
      FOODS.carbs.find(f => f.key === 'farro'),
      FOODS.carbs.find(f => f.key === 'pasta integrale'),
      FOODS.carbs.find(f => f.key === 'patate dolci')
    ].filter(Boolean), inc, exc);
    const prot = chooseFood([
      FOODS.proteins.find(f => f.key === 'pollo'),
      FOODS.proteins.find(f => f.key === 'salmone'),
      FOODS.proteins.find(f => f.key === 'tofu'),
      FOODS.proteins.find(f => f.key === 'ceci'),
      FOODS.proteins.find(f => f.key === 'lenticchie')
    ].filter(Boolean), inc, exc);
    const veg  = chooseFood(FOODS.veggies, inc, exc);
    const oil  = FOODS.fats.find(f => f.key === 'olio evo');
    let items = [];
    if (carb && !isExcluded(carb, exc)) items.push({ food: carb, qty: (carb.key === 'patate dolci' ? 260 : 80) });
    if (prot && !isExcluded(prot, exc)) items.push({ food: prot, qty: (prot.unit === 'pz' ? 2 : 120) });
    if (veg  && !isExcluded(veg, exc)) items.push({ food: veg, qty: 200 });
    if (oil  && !isExcluded(oil, exc)) items.push({ food: oil, qty: 12 });
    return tunePortions(items, target);
  }
  function generatePlan(totalKcal, tol, inc, exc) {
    const dist = [0.20, 0.10, 0.40, 0.10, 0.20];
    const targets = dist.map(p => totalKcal * p);
    const names = ['Colazione','Spuntino mattutino','Pranzo','Spuntino pomeridiano','Cena'];
    const builders = [buildBreakfast, buildSnack, buildMainMeal, buildSnack, buildMainMeal];
    const meals = [];
    for (let i = 0; i < 5; i++) {
      const items = builders[i](targets[i], inc, exc);
      const kcal = items.reduce((s, it) => s + kcalOf(it.food, it.qty), 0);
      meals.push({ name: names[i], target: Math.round(targets[i]), items, kcal: Math.round(kcal) });
    }
    const total = meals.reduce((s, m) => s + m.kcal, 0);
    return { meals, totalKcal: Math.round(total) };
  }
  function renderPlan(name, cal, plan) {
    currentPlanData = plan;
    els.patientLabel.textContent = `Paziente: ${name || '—'}`;
    els.kcalLabel.textContent = `Fabbisogno: ${cal} kcal`;
    els.tbody.innerHTML = '';
    for (const meal of plan.meals) {
      const trH = document.createElement('tr');
      trH.className = 'meal-row';
      trH.innerHTML = `<td colspan="3">${meal.name} <span class="tag">${meal.target} kcal</span></td>`;
      els.tbody.append(trH);
      for (const it of meal.items) {
        const tr = document.createElement('tr');
        const kc = fmtKcal(kcalOf(it.food, it.qty));
        tr.innerHTML = `<td>${it.food.name}</td><td>${fmtQty(it.food, it.qty)}</td><td class="kcal">${kc}</td>`;
        els.tbody.append(tr);
      }
      const sub = meal.items.reduce((s, it) => s + kcalOf(it.food, it.qty), 0);
      const trS = document.createElement('tr');
      trS.innerHTML = `<td class="subtotal">Subtotale</td><td></td><td class="kcal subtotal">${fmtKcal(sub)}</td>`;
      els.tbody.append(trS);
    }
    els.total.textContent = `${plan.totalKcal}`;
    // abilita pulsanti
    els.save.disabled = false;
    els.pdf.disabled = false;
  }
  function loadPlan(entry) {
    els.cal.value = entry.cal;
    els.calOut.textContent = `${entry.cal} kcal`;
    els.name.value = entry.name || '';
    els.inc.value = entry.inc || '';
    els.exc.value = entry.exc || '';
    els.tol.value = entry.tol || 8;
    els.tolOut.textContent = `±${entry.tol}%`;
    currentPlanData = entry.plan;
    renderPlan(entry.name, entry.cal, entry.plan);
    saveLast();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  /*
   * Eventi UI
   */
  els.cal.addEventListener('input', () => {
    els.calOut.textContent = `${els.cal.value} kcal`;
    saveLast();
  });
  els.name.addEventListener('input', saveLast);
  els.inc.addEventListener('input', saveLast);
  els.exc.addEventListener('input', saveLast);
  els.tol.addEventListener('input', () => {
    els.tolOut.textContent = `±${els.tol.value}%`;
    saveLast();
  });
  els.gen.addEventListener('click', () => {
    const name = els.name.value.trim();
    const cal  = +els.cal.value;
    const tol  = +els.tol.value;
    const inc  = splitList(els.inc.value);
    const exc  = splitList(els.exc.value);
    const plan = generatePlan(cal, tol, inc, exc);
    renderPlan(name, cal, plan);
    // enable save + pdf
    els.save.disabled = false;
    els.pdf.disabled = false;
    // Scroll to preview for better UX
    document.querySelector('.preview').scrollIntoView({ behavior:'smooth' });
  });
  els.save.addEventListener('click', () => {
    if (!currentPlanData) return;
    const entry = {
      id: generateId(),
      ts: Date.now(),
      name: els.name.value.trim() || '—',
      cal: +els.cal.value,
      inc: els.inc.value,
      exc: els.exc.value,
      tol: +els.tol.value,
      plan: currentPlanData
    };
    const list = getHistory();
    list.unshift(entry);
    setHistory(list);
    renderHistory();
  });
  els.pdf.addEventListener('click', async () => {
    if (!currentPlanData) return;
    const entry = {
      name: els.name.value.trim() || '—',
      cal: +els.cal.value,
      plan: currentPlanData
    };
    await exportPDF(entry);
  });

  /*
   * PDF export
   */
  async function exportPDF(data) {
    const { PDFDocument, StandardFonts } = PDFLib;
    let firstBytes, lastBytes;
    if (USE_SINGLE_FIXED_PDF) {
      const bytes = await fetch(FIXED_PDF_URL).then(r => r.arrayBuffer());
      const src = await PDFDocument.load(bytes);
      const count = src.getPageCount();
      const firstDoc = await PDFDocument.create();
      const lastDoc  = await PDFDocument.create();
      const [p1] = await firstDoc.copyPages(src, [0]);
      firstDoc.addPage(p1);
      const [pL] = await lastDoc.copyPages(src, [count - 1]);
      lastDoc.addPage(pL);
      firstBytes = await firstDoc.save();
      lastBytes  = await lastDoc.save();
    } else {
      firstBytes = await fetch(FIRST_PDF).then(r => r.arrayBuffer());
      lastBytes  = await fetch(LAST_PDF).then(r => r.arrayBuffer());
    }
    const firstPdf = await PDFDocument.load(firstBytes);
    const lastPdf  = await PDFDocument.load(lastBytes);
    const out = await PDFDocument.create();
    // Import first fixed page
    const [f1] = await out.copyPages(firstPdf, [0]);
    out.addPage(f1);
    // Create central dynamic page (A4 size)
    const page = out.addPage([595, 842]);
    const font = await out.embedFont(StandardFonts.Helvetica);
    const fontB = await out.embedFont(StandardFonts.HelveticaBold);
    let y = 800;
    const x = 40;
    const w = 515;
    // Header
    page.drawText('DIETA PERSONALIZZATA – GIORNALIERA', { x, y, size: 14, font: fontB });
    y -= 18;
    page.drawLine({ start: { x, y }, end: { x: x + w, y }, thickness: 1.5 });
    y -= 20;
    page.drawText(`Paziente: ${data.name || '—'}`, { x, y, size: 10, font });
    page.drawText(`Fabbisogno: ${data.cal} kcal`, { x: x + 300, y, size: 10, font });
    y -= 14;
    page.drawText('Ripartizione: 20% · 10% · 40% · 10% · 20%', { x, y, size: 8.5, font });
    y -= 20;
    // Draw table
    function drawRow(a, b, c, bold = false) {
      const size = bold ? 10 : 9;
      const fnt = bold ? fontB : font;
      page.drawText(a, { x, y, size, font: fnt });
      page.drawText(b, { x: x + 320, y, size, font: fnt });
      const txtWidth = fnt.widthOfTextAtSize(c, size);
      page.drawText(c, { x: x + w - txtWidth, y, size, font: fnt });
      y -= 12;
    }
    for (const m of data.plan.meals) {
      y -= 4;
      drawRow(`${m.name} (target ${m.target} kcal)`, '', '', true);
      y -= 4;
      for (const it of m.items) {
        const kc = Math.round(kcalOf(it.food, it.qty));
        drawRow('• ' + it.food.name, fmtQty(it.food, it.qty), `${kc}`);
      }
      const sub = m.items.reduce((s, it) => s + kcalOf(it.food, it.qty), 0);
      drawRow('Subtotale', '', `${Math.round(sub)}`);
      y -= 6;
    }
    y -= 8;
    drawRow('Totale giornata', '', `${data.plan.totalKcal}`, true);
    // Import last fixed page
    const [l1] = await out.copyPages(lastPdf, [0]);
    out.addPage(l1);
    const pdfBytes = await out.save();
    const blob = new Blob([pdfBytes], { type:'application/pdf' });
    const fname = `Dieta_Personalizzata_${(data.name || 'paziente').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fname;
    link.click();
    setTimeout(() => URL.revokeObjectURL(link.href), 1000);
  }
  // Inizializza
  loadLast();
  renderHistory();
  </script>
</body>
</html>